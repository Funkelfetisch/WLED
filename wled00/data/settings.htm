<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
	<title>WLED Settings</title>
	<script>
		var d=document;
		var loc = false, locip;
		function gId(n){return d.getElementById(n);}
		// https://www.educative.io/edpresso/how-to-dynamically-load-a-js-file-in-javascript
		function loadJS(FILE_URL, async = true) {
			let scE = d.createElement("script");
			scE.setAttribute("src", FILE_URL);
			scE.setAttribute("type", "text/javascript");
			scE.setAttribute("async", async);
			d.body.appendChild(scE);
			// success event 
			scE.addEventListener("load", () => {
				//console.log("File loaded");
				GetV();
			});
			// error event
			scE.addEventListener("error", (ev) => {
				console.log("Error on loading file", ev);
				alert("Loading of configuration script failed.\nIncomplete page data!");
			});
		}
		function isO(i) { return (i && typeof i === 'object' && !Array.isArray(i)); }
		// load settings and insert values into DOM
		function ldS() {
			var url = (loc?`http://${locip}`:'') + '/cfg.json';
			fetch(url, {
				method: 'get'
			})
			.then(res => {
				if (!res.ok) gId('lserr').style.display = "inline";
				return res.json();
			})
			.then(json => {
				umCfg = json.um;
				urows="";
				if (isO(umCfg)) {
					for (const [k,o] of Object.entries(umCfg)) {
							urows += `<button type="submit" onclick="window.location=\'./settings/um?um=${k}\'">${k} (UM ☾)</button>`;
					}
				}
				gId("configMenu").innerHTML = urows;
				var url = (loc?`http://${locip}`:'') + '/settings/s.js?p=0';
				loadJS(url, false);	// If we set async false, file is loaded and executed, then next statement is processed
			})
			.catch((error)=>{
				gId('lserr').style.display = "inline";
				console.log(error);
			});
		}
		function S(){
			if (window.location.protocol == "file:") {
				loc = true;
				locip = localStorage.getItem('locIp');
				if (!locip) {
					locip = prompt("File Mode. Please enter WLED IP!");
					localStorage.setItem('locIp', locip);
				}
			}
			//WLEDMM: add ldS and move loadJS there (like in settings_um)
			ldS();
		}
	</script>
	<style>
		body {
			text-align: center;
			background: #222;
			height: 100px;
			margin: 0;
		}
		html {
			--h: 9vh;
		}
		button {
			background: #333;
			color: #fff;
			font-family: Verdana, Helvetica, sans-serif;
			display: block;
			border: 1px solid #333;
			border-radius: var(--h);
			font-size: 6vmin;
			/* height: var(--h); WLEDMM remove to allow more compact display*/
			width: calc(100% - 40px);
			margin: 2vh auto 0;
			cursor: pointer;
		}
	</style>
	<style>@import url("style.css");</style>
</head>
<body onload="S()">


<div id="imgw">
	<img class="wi" style="filter: invert(100%); margin: 23px;" alt="" src="data:image/svg+xml,%3Csvg%20id%3D%22Ebene_2%22%20data-name%3D%22Ebene%202%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20280.92%2035.69%22%3E%20%3Cdefs%3E%20%3Cstyle%3E%20.cls-1%20{%20fill%3A%20%23010101%3B%20}%20%3C%2Fstyle%3E%20%3C%2Fdefs%3E%20%3Cg%20id%3D%22Layer_1%22%20data-name%3D%22Layer%201%22%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%2226.19%2029.35%203.02%20.13%202.92%200%200%200%200%2035.15%203.14%2035.15%203.14%205.17%2026.91%2035.15%2029.33%2035.15%2029.33%200%2026.19%200%2026.19%2029.35%22%2F%3E%20%3Cpath%20class%3D%22cls-1%22%20d%3D%22M102.59%2C17.02c2.55-1.25%2C5.21-3.62%2C5.21-8.1v-.1c0-2.22-.78-4.12-2.32-5.66C103.45%2C1.13%2C100.18%2C0%2C96.28%2C0h-14.57V35.15h15.31c7.71%2C0%2C12.7-3.82%2C12.7-9.74v-.1c0-3.97-2.46-6.82-7.13-8.29Zm-6.61-1.11h-11.03V3.06h11.28c5.1%2C0%2C8.27%2C2.3%2C8.27%2C6.01v.1c0%2C4.15-3.26%2C6.74-8.52%2C6.74Zm1.14%2C16.19h-12.16v-13.15h11.33c6.54%2C0%2C10.14%2C2.26%2C10.14%2C6.35v.1c0%2C4.14-3.57%2C6.7-9.31%2C6.7Z%22%2F%3E%20%3Cpath%20class%3D%22cls-1%22%20d%3D%22M147.33%2C20.48c0%2C7.76-4.06%2C12.21-11.13%2C12.21s-11.33-4.54-11.33-12.46V0h-3.24V20.48c0%2C9.38%2C5.54%2C15.21%2C14.47%2C15.21s14.47-5.94%2C14.47-15.5V0h-3.24V20.48h0Z%22%2F%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%22167.75%200%20164.5%200%20164.5%2035.15%20187.98%2035.15%20187.98%2032.1%20167.75%2032.1%20167.75%200%22%2F%3E%20%3Crect%20class%3D%22cls-1%22%20x%3D%22200.24%22%20y%3D%220%22%20width%3D%223.24%22%20height%3D%2235.14%22%2F%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%22215.85%203.05%20227.86%203.05%20227.86%2035.15%20231.1%2035.15%20231.1%203.05%20243.11%203.05%20243.11%200%20215.85%200%20215.85%203.05%22%2F%3E%20%3Cg%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%2242.81%2035.15%2068.25%2035.15%2068.25%2032.1%2046.05%2032.1%2042.81%2032.1%2042.81%2035.15%22%2F%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%2246.36%2015.91%2042.81%2015.91%2042.81%2018.95%2046.36%2018.95%2068.01%2018.95%2068.01%2015.91%2046.36%2015.91%22%2F%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%2268.01%203.05%2068.01%200%2042.81%200%2042.81%203.05%2046.05%203.05%2068.01%203.05%22%2F%3E%20%3C%2Fg%3E%20%3Cg%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%22255.47%2035.15%20280.92%2035.15%20280.92%2032.1%20258.72%2032.1%20255.47%2032.1%20255.47%2035.15%22%2F%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%22259.03%2015.91%20255.47%2015.91%20255.47%2018.95%20259.03%2018.95%20280.67%2018.95%20280.67%2015.91%20259.03%2015.91%22%2F%3E%20%3Cpolygon%20class%3D%22cls-1%22%20points%3D%22280.67%203.05%20280.67%200%20255.47%200%20255.47%203.05%20258.72%203.05%20280.67%203.05%22%2F%3E%20%3C%2Fg%3E%20%3C%2Fg%3E%20%3C%2Fsvg%3E" />
</div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Welcome! Here you can OVERWRITE your configuration with the NEBULITE defaults for each product. </p>
<label for="productType">Choose your product:</label>

<select name="productType" id="productType">
  <option value="fp1">Fanny Pack 1</option>
  <option value="fp2">Fanny Pack 2</option>
  <option value="fp2plus">Fanny Pack 2+</option>
  <option value="fp3">Fanny Pack 3</option>
  <option value="bp1">Drawstring Backpack 1</option>
  <option value="bp2">Drawstring Backpack 2</option>
  <option value="j">Jacket</option>
  <option value="ct">Crop-Top</option>
</select> 
<button id="nebuliteRestore">Restore!</button>
<button type=submit id="b" onclick="window.location='/'">Back</button>
<div id="toast"></div>
<script>
	var timeout;
	function showToast(text, error = false)
	{
		var x = gId("toast");
		x.innerHTML = text;
		x.classList.add(error ? "error":"show");
		clearTimeout(timeout);
		x.style.animation = 'none';
		timeout = setTimeout(function(){ x.classList.remove("show"); }, 2900);
	}
	function uploadFile(fO,name) {
		var req = new XMLHttpRequest();
		req.addEventListener('load', function(){showToast(this.responseText,this.status >= 400)});
		req.addEventListener('error', function(e){showToast(e.stack,true);});
		req.open("POST", "/upload");
		var formData = new FormData();
		const blob = new Blob([fO], {type : 'text/plain'})
		formData.append("data", blob, name);
		req.send(formData);
		return false;
	}


	var additionalTemplate = '{"light":{"scale-bri":100,"pal-mode":0,"aseg":false,"gc":{"bri":1,"col":1},"tr":{"mode":true,"dur":7,"pal":0},"nl":{"mode":1,"dur":60,"tbri":0,"macro":0}},"def":{"ps":0,"on":true,"bri":255}}';
	additionalTemplate = JSON.parse(additionalTemplate);

	products = Array();
	products["fp1"] = "";
	products["fp2"] = "";
	products["fp2plus"] = '{"hw":{"led":{"total":4,"maxpwr":1500,"ledma":0,"cct":false,"cr":false,"cb":0,"fps":42,"rgbwm":255,"ld":true,"ins":[{"start":0,"len":4,"pin":[26],"order":34,"rev":false,"skip":0,"type":30,"ref":false,"rgbwm":1}]}}}'
	products["fp3"] = "";
	products["bp1"] = "";
	products["bp2"] = "";
	products["j"] = "";
	products["ct"] = "";

	const btn = document.querySelector('#nebuliteRestore');
	const productType = document.querySelector('#productType');
	btn.onclick = (event) => {
		event.preventDefault();

		const templateLoader = new XMLHttpRequest();
		templateLoader.onload = function() {
			console.log("response", this.responseText);
			const template = JSON.parse(this.responseText);

			// const productLoader = new XMLHttpRequest();
			// productLoader.onload = function() {
			// 	const product = JSON.parse(this.responseText);
				
			// 	console.log({ ...template, ...product });
			// 	uploadFile(JSON.stringify({ ...template, ...product }),'/cfg.json');
			// }
			// productLoader.open("GET", "/config-" + productType.options[productType.selectedIndex].value + ".json", true);
			// productLoader.send();

			var product = products[productType.options[productType.selectedIndex].value] ? products[productType.options[productType.selectedIndex].value] : "";
			product = JSON.parse(product);

			const merged = Object.assign(template, additionalTemplate, product);

			console.log("template", template);
			console.log("additionalTemplate", additionalTemplate);
			console.log("product", product)

			console.log("merged", merged);
			uploadFile(JSON.stringify(merged),'/cfg.json');
		}
		// templateLoader.open("GET", "/template.json", true);
		templateLoader.open("GET", "/cfg.json", true); // temporary until I figure out how to put files to SPIFFS
		templateLoader.send();
	};
</script>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Beyond here be dragons. You can't fuck it up completely, but you can lock yourself out if you're not careful with the WiFi Setup!</p>
<p>We take no responsibility for that and charge shipping costs for hard resets of bricked devices.</p>




<button type=submit id="b" onclick="window.location='/'">Back</button>
<button type="submit" onclick="window.location='./settings/wifi'">WiFi Setup</button>
<button type="submit" onclick="window.location='./settings/leds'">LED Preferences</button>
<button id="2dbtn" style="display:none;" type="submit" onclick="window.location='./settings/2D'">2D Configuration</button>
<div id="configMenu">Loading...</div>
<button type="submit" onclick="window.location='./settings/um'">Usermods (pins)</button> <!--WLEDMM: Move below UMs-->
<button type="submit" onclick="window.location='./settings/ui'">User Interface</button>
<button id="dmxbtn" style="display:none;" type="submit" onclick="window.location='./settings/dmx'">DMX Output</button>
<button type="submit" onclick="window.location='./settings/sync'">Sync Interfaces</button>
<button type="submit" onclick="window.location='./settings/time'">Time & Macros</button>
<button type="submit" onclick="window.location='./settings/sec'">Security & Updates</button>
<button type="submit" onclick="window.location='./edit'">File System ☾</button> <!--WLEDMM-->
</body>
</html>